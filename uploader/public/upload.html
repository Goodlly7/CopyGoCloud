<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>CopyGo → Google Drive (server)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{margin:0;background:#0b1020;color:#e6f0ff;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:42px auto 80px;padding:0 16px}
    .card{background:rgba(16,25,52,.78);backdrop-filter:blur(6px);border:1px solid rgba(124,58,237,.22);border-radius:22px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .pad{padding:22px}
    .title{font-size:22px;font-weight:800;margin-bottom:10px}
    .drop{border:2px dashed rgba(148,163,184,.35);border-radius:16px;height:220px;display:grid;place-items:center;color:#cbd5e1;text-align:center}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    button{background:#2563eb;border:none;color:#fff;padding:12px 16px;border-radius:12px;font-size:16px;cursor:pointer}
    button.sec{background:#334155}
    button:disabled{opacity:.6;cursor:not-allowed}
    input[type=file]{display:none}
    .item{background:#0f1a36;border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:12px 14px;margin:10px 0}
    .name{font-weight:600}
    .status{font-size:13px;color:#a9b7d9;margin-top:6px}
    .ok{color:#10b981} .err{color:#ef4444}
    .bar{height:6px;border-radius:999px;background:#1f2a4d;margin-top:8px;overflow:hidden}
    .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#7c3aed)}
    .sid{color:#a3b0d6;font-size:14px}
    pre#log{background:#0b1020;color:#b7ffb7;border:1px solid rgba(124,58,237,.25);padding:12px;border-radius:12px;max-height:220px;overflow:auto}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .sidinp{background:#0f1a36;border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:10px 12px;color:#e6f0ff}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card pad">
    <div class="title">CopyGo Cloud → Google Drive <span class="sid">/upload?sid=&lt;SID&gt;</span></div>

    <div class="row">
      <label for="sid">SID:</label>
      <input id="sid" class="sidinp" value="TEST123" />
      <button id="rnd" class="sec">Случайный SID</button>
    </div>

    <label class="drop" id="drop">
      <div>
        <div style="font-size:20px;font-weight:800">Перетащите файлы сюда</div>
        <div style="color:#a9b7d9;font-size:14px">или нажмите «Выбрать файлы»</div>
      </div>
      <input type="file" id="picker" multiple />
    </label>

    <div class="btns">
      <button id="chooseBtn">Выбрать файлы</button>
      <button id="uploadBtn" disabled>Загрузить</button>
      <button id="clearBtn" class="sec">Очистить список</button>
    </div>

    <div id="list"></div>
    <pre id="log"></pre>
  </div>
</div>

<script>
const MAX_SIZE = 100 * 1024 * 1024; // 100MB
const logEl = document.getElementById('log');
const listEl = document.getElementById('list');
const uploadBtn = document.getElementById('uploadBtn');
const picker = document.getElementById('picker');
const drop = document.getElementById('drop');
const sidEl = document.getElementById('sid');
const files = [];

function log(m){ logEl.textContent += (typeof m==='string'?m:JSON.stringify(m)) + "\n"; }
function safeName(n){ return n.replace(/[^\w.\- ]+/g,'_'); }
function addItem(file){
  const el = document.createElement('div'); el.className='item';
  el.innerHTML = `
    <div class="name">${file.name} <span style="opacity:.7;font-size:12px">(${Math.round(file.size/1024)} КБ)</span></div>
    <div class="status">ожидание…</div>
    <div class="bar"><i></i></div>`;
  listEl.appendChild(el);
  return { st: el.querySelector('.status'), bar: el.querySelector('.bar>i') };
}
document.getElementById('chooseBtn').onclick = () => picker.click();
document.getElementById('clearBtn').onclick = () => { files.length=0; listEl.innerHTML=''; uploadBtn.disabled=true; };
document.getElementById('rnd').onclick = () => { sidEl.value = 'SID-' + Math.random().toString(36).slice(2,7).toUpperCase(); };

picker.addEventListener('change', onPicked);
['dragenter','dragover','dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();}));
drop.addEventListener('drop', e => onPickedFiles(Array.from(e.dataTransfer.files||[])));

function onPicked(){ onPickedFiles(Array.from(picker.files||[])); }
function onPickedFiles(arr){
  for (const f of arr){
    if (f.size > MAX_SIZE){ log(`Пропуск: ${f.name} (> 100 МБ)`); continue; }
    const ui = addItem(f);
    f._st = ui.st; f._bar = ui.bar;
    files.push(f);
  }
  uploadBtn.disabled = files.length===0;
}

uploadBtn.addEventListener('click', async () => {
  if (!files.length) return;
  const sid = sidEl.value.trim() || 'default';

  for (const f of files){
    f._st.textContent = 'загрузка…';
    const fd = new FormData();
    const cleaned = new File([f], safeName(f.name), { type: f.type });
    fd.append('file', cleaned, cleaned.name);
    try{
      const resp = await uploadOne(`/upload?sid=${encodeURIComponent(sid)}`, fd, pct => f._bar.style.width = pct + '%');
      f._st.textContent = 'готово ✓'; f._st.classList.add('ok');
      log(resp);
    }catch(e){
      f._st.textContent = 'ошибка'; f._st.classList.add('err'); log(e.message||e);
    }
  }
});

function uploadOne(url, formData, onProgress){
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', url);
    xhr.responseType = 'json';
    xhr.upload.onprogress = (ev)=>{
      if (ev.lengthComputable && onProgress){
        onProgress(Math.round(100*ev.loaded/ev.total));
      }
    };
    xhr.onerror = ()=> reject(new Error('network_error'));
    xhr.onload = ()=>{
      if (xhr.status>=200 && xhr.status<300) resolve(JSON.stringify(xhr.response));
      else reject(new Error('http_'+xhr.status+': '+(xhr.responseText||'error')));
    };
    xhr.send(formData);
  });
}

// Проверка health
fetch('/health').then(r=>r.json()).then(j=>log('health: '+JSON.stringify(j))).catch(e=>log('health error: '+e));
</script>
</body>
</html>
